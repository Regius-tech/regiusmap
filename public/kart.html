<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Triflex Kart</title>

  <style>
    body {
      font-family: Poppins, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #001f3f;
      overflow: hidden;
    }

    #map {
      height: 100vh;
      width: 100%;
    }

    /* Sidebar styling */
    .sidebar {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 280px;
      background-color: rgba(2, 28, 60, 0.97);
      color: white;
      padding: 80px 20px 20px 20px;
      transform: translateX(-100%);
      transition: transform 0.4s ease;
      box-shadow: 3px 0 15px rgba(0,0,0,0.4);
      z-index: 1001;
      overflow-y: auto;
    }

    .sidebar.open { transform: translateX(0); }

    .menu-toggle {
      position: absolute;
      top: 20px;
      left: 20px;
      background-color: #0074D9;
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      z-index: 1100;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    .menu-toggle:hover { background-color: #005fa3; }

    .sidebar label {
      font-weight: bold;
      font-size: 14px;
      display: block;
      margin-top: 15px;
    }

    .sidebar select,
    .sidebar input[type="checkbox"],
    .sidebar input[type="text"] {
      width: 100%;
      margin-top: 5px;
      padding: 8px;
      border-radius: 6px;
      border: none;
      outline: none;
      font-size: 14px;
    }

    .sidebar .btn-secondary {
      display: block;
      margin-top: 12px;
      text-align: center;
      background-color: rgba(255,255,255,0.15);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      padding: 8px 0;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    .sidebar .btn-secondary:hover { background-color: rgba(255,255,255,0.25); }

    #themeSwitch {
      width: 100%;
      margin-top: 15px;
      border: none;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      background-color: #0074D9;
      color: white;
      transition: background-color 0.3s ease;
    }
    #themeSwitch:hover { background-color: #005fa3; }

    .info-window {
      background-color: #012040;
      color: #fff;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 14px;
      font-family: Poppins, sans-serif;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    .info-window b { color: #FFD700; }

    .suggestions {
      background-color: white;
      color: black;
      border-radius: 8px;
      margin-top: 5px;
      max-height: 180px;
      overflow-y: auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      display: none;
    }
    .suggestions div { padding: 8px; cursor: pointer; }
    .suggestions div:hover { background-color: #e0e0e0; }

    /* Fjern hvit kant og stor ramme fra InfoWindow */
    .gm-style-iw {
      background-color: #012040 !important;
      box-shadow: none !important;
      padding: 0 !important;
      border-radius: 10px !important;
      max-width: none !important;
    }
    .gm-style-iw-t::after,
    .gm-style-iw-t::before {
      background: none !important;
      display: none !important;
    }
    .gm-style .gm-style-iw-c {
      padding: 0 !important;
      background: #012040 !important;
      box-shadow: none !important;
      border-radius: 10px !important;
    }
    .gm-style .gm-style-iw-d {
      overflow: visible !important;
    }
  </style>
</head>

<body>
  <button class="menu-toggle" id="menuToggle">‚ò∞ Meny</button>

  <div class="sidebar" id="sidebar">
    <label for="company-filter">Selskap:</label>
    <select id="company-filter">
      <option value="all">Alle</option>
      <option value="Transportsentralen Oslo">Transportsentralen Oslo</option>
      <option value="Moss Transportforum">Moss Transportforum</option>
      <option value="Bl√• Kur√©r">Bl√• Kur√©r</option>
      <option value="TS Oslo Budtjenester">TS Oslo Budtjenester</option>
    </select>

    <label><input type="checkbox" id="activeToday" checked> Aktive i dag</label>

    <label for="vehicleSearch">S√∏k kj√∏ret√∏y:</label>
    <input type="text" id="vehicleSearch" placeholder="Skriv kj√∏ret√∏y-navn...">
    <div id="vehicleSuggestions" class="suggestions"></div>

    <label for="typeSearch">S√∏k biltype:</label>
    <input type="text" id="typeSearch" placeholder="Eks: varebil, lastebil...">
    <div id="typeSuggestions" class="suggestions"></div>

    <label for="placeSearch">S√∏k sted/adresse:</label>
    <input type="text" id="placeSearch" placeholder="S√∏k etter adresse...">

    <button id="themeSwitch">üåô M√∏rk modus</button>
    <a class="btn-secondary" href="cars.html">Bilpark</a>
    <a class="btn-secondary" href="dashboard.html">Dashboard</a>
  </div>

  <div id="map"></div>

  <script>
    let map, darkMode = true;
    let markers = {};
    let vehicleData = [];
    let activeInfoWindow = null;

    const darkStyle = [
      { elementType: "geometry", stylers: [{ color: "#1d2c4d" }] },
      { elementType: "labels.text.fill", stylers: [{ color: "#8ec3b9" }] },
      { elementType: "labels.text.stroke", stylers: [{ color: "#1a3646" }] },
      { featureType: "water", elementType: "geometry", stylers: [{ color: "#0e1626" }] },
      { featureType: "road", elementType: "geometry", stylers: [{ color: "#304a7d" }] },
      { featureType: "poi", elementType: "geometry", stylers: [{ color: "#283d6a" }] },
      { featureType: "landscape.natural", elementType: "geometry", stylers: [{ color: "#023e58" }] }
    ];

    const companyColors = {
      "Transportsentralen Oslo": "#ffffff",
      "Bl√• Kur√©r": "#FFD700",
      "Moss Transportforum": ["#00008b", "#8b0000"],
      "TS Oslo Budtjenester": "#004080"
    };

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 59.9139, lng: 10.7522 },
        zoom: 10,
        styles: darkMode ? darkStyle : [],
        mapTypeControl: false,
        fullscreenControl: true
      });

      document.getElementById("themeSwitch").addEventListener("click", () => {
        darkMode = !darkMode;
        map.setOptions({ styles: darkMode ? darkStyle : [] });
        document.getElementById("themeSwitch").textContent = darkMode ? "üåô M√∏rk modus" : "‚òÄÔ∏è Lys modus";
      });

      document.getElementById("menuToggle").addEventListener("click", () => {
        document.getElementById("sidebar").classList.toggle("open");
      });

      loadPositions();
      document.getElementById("company-filter").addEventListener("change", loadPositions);
      document.getElementById("activeToday").addEventListener("change", loadPositions);
      setInterval(loadPositions, 10000);

      const placeInput = document.getElementById("placeSearch");
      const autocomplete = new google.maps.places.Autocomplete(placeInput);
      autocomplete.bindTo("bounds", map);
      autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (place.geometry && place.geometry.location) {
          map.panTo(place.geometry.location);
          map.setZoom(14);
        }
      });

      placeInput.addEventListener("keydown", async (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          const geocoder = new google.maps.Geocoder();
          geocoder.geocode({ address: placeInput.value }, (results, status) => {
            if (status === "OK" && results[0]) {
              map.panTo(results[0].geometry.location);
              map.setZoom(14);
            }
          });
        }
      });

      document.getElementById("vehicleSearch").addEventListener("input", showVehicleSuggestions);
      document.getElementById("typeSearch").addEventListener("input", showTypeSuggestions);
    }

    function formatTimestamp(timestamp) {
      if (!timestamp) return "Ukjent tid";
      return new Date(timestamp).toLocaleTimeString('no-NO', { hour: '2-digit', minute: '2-digit' });
    }

    function createPinDataURL(vehicle) {
      return new Promise((resolve) => {
        const canvas = document.createElement("canvas");
        canvas.width = 60; canvas.height = 70;
        const ctx = canvas.getContext("2d");
        const color = companyColors[vehicle.company] || "#888";

        ctx.fillStyle = Array.isArray(color) ? color[0] : color;
        ctx.beginPath();
        ctx.moveTo(30, 70); ctx.lineTo(20, 50); ctx.lineTo(40, 50); ctx.closePath(); ctx.fill();

        if (Array.isArray(color)) {
          const grad = ctx.createLinearGradient(0, 0, 60, 0);
          grad.addColorStop(0, color[0]); grad.addColorStop(1, color[1]);
          ctx.fillStyle = grad;
        } else ctx.fillStyle = color;

        ctx.beginPath(); ctx.arc(30, 30, 20, 0, Math.PI * 2); ctx.fill();

        if (vehicle.company === "Transportsentralen Oslo") {
          ctx.lineWidth = 4; ctx.strokeStyle = "red";
          ctx.beginPath(); ctx.arc(30, 30, 20, 0, Math.PI * 2); ctx.stroke();
        }

        const img = new Image();
        img.crossOrigin = "anonymous";
        img.src = vehicle.logo;
        img.onload = () => {
          ctx.save(); ctx.beginPath(); ctx.arc(30, 30, 18, 0, Math.PI * 2);
          ctx.closePath(); ctx.clip(); ctx.drawImage(img, 12, 12, 36, 36); ctx.restore();
          resolve(canvas.toDataURL());
        };
        img.onerror = () => resolve(canvas.toDataURL());
      });
    }

    async function loadPositions() {
      try {
        const response = await fetch("/api/positions");
        if (!response.ok) throw new Error("Kunne ikke hente posisjoner fra API");
        const data = await response.json();
        vehicleData = data;

        const activeToday = document.getElementById('activeToday').checked;
        const selectedCompany = document.getElementById('company-filter').value;

        const filtered = data.filter(v => {
          const c = selectedCompany === 'all' || v.company === selectedCompany;
          const a = !activeToday || v.isActiveToday;
          return c && a && v.isParticipant;
        });

        const ids = filtered.map(v => String(v.id));

        for (const v of filtered) {
          if (!v.latitude || !v.longitude) continue;
          const id = String(v.id);
          const pos = { lat: v.latitude, lng: v.longitude };

          if (markers[id]) markers[id].setPosition(pos);
          else {
            const iconUrl = await createPinDataURL(v);
            const marker = new google.maps.Marker({
              map, position: pos,
              icon: { url: iconUrl, scaledSize: new google.maps.Size(45, 55) },
              title: v.name
            });

            const infoWindow = new google.maps.InfoWindow({
              content: `<div class="info-window">
                          <b>Navn:</b> ${v.name}<br>
                          <b>Type:</b> ${v.type}<br>
                          <b>Palleplasser:</b> ${v.palleplasser}<br>
                          <b>Klokkeslett:</b> ${formatTimestamp(v.time)}<br>
                          <b>Selskap:</b> ${v.company}
                        </div>`
            });

            marker.addListener('click', () => {
              if (activeInfoWindow) activeInfoWindow.close();
              activeInfoWindow = infoWindow;
              infoWindow.open(map, marker);
            });

            markers[id] = marker;
          }
        }

        for (const id in markers)
          if (!ids.includes(id)) { markers[id].setMap(null); delete markers[id]; }

      } catch (err) { console.error('Error loading positions:', err); }
    }

    function showVehicleSuggestions(e) {
      const input = e.target.value.toLowerCase();
      const box = document.getElementById("vehicleSuggestions");
      box.innerHTML = "";
      if (input.length < 2) return box.style.display = "none";
      const matches = vehicleData.filter(v => v.name && v.name.toLowerCase().includes(input));
      if (!matches.length) return box.style.display = "none";
      matches.forEach(v => {
        const d = document.createElement("div");
        d.textContent = `${v.name} (${v.company})`;
        d.onclick = () => {
          box.style.display = "none";
          document.getElementById("vehicleSearch").value = v.name;
          if (markers[v.id]) {
            map.panTo(markers[v.id].getPosition());
            map.setZoom(14);
            google.maps.event.trigger(markers[v.id], 'click');
          }
        };
        box.appendChild(d);
      });
      box.style.display = "block";
    }

    function showTypeSuggestions(e) {
      const input = e.target.value.toLowerCase();
      const box = document.getElementById("typeSuggestions");
      box.innerHTML = "";
      if (input.length < 2) return box.style.display = "none";
      const matches = vehicleData.filter(v => v.type && v.type.toLowerCase().includes(input));
      if (!matches.length) return box.style.display = "none";
      matches.forEach(v => {
        const d = document.createElement("div");
        d.textContent = `${v.type} - ${v.name}`;
        d.onclick = () => {
          box.style.display = "none";
          document.getElementById("typeSearch").value = v.type;
          if (markers[v.id]) {
            map.panTo(markers[v.id].getPosition());
            map.setZoom(14);
            google.maps.event.trigger(markers[v.id], 'click');
          }
        };
        box.appendChild(d);
      });
      box.style.display = "block";
    }
  </script>

  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBtSvAG_uN9QBI0Fi_GOJVIyAjd1JlMvNg&callback=initMap&libraries=places&v=beta">
  </script>
</body>
</html>
