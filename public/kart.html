<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Triflex Kart</title>

  <style>
    body {
      font-family: Poppins, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #001f3f;
      overflow: hidden;
    }

    #map { height: 100vh; width: 100%; }

    /* Sidebar */
    .sidebar {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 280px;
      background-color: rgba(2, 28, 60, 0.97);
      color: white;
      padding: 80px 20px 20px 20px;
      transform: translateX(-100%);
      transition: transform 0.4s ease;
      box-shadow: 3px 0 15px rgba(0,0,0,0.4);
      z-index: 1001;
      overflow-y: auto;
    }
    .sidebar.open { transform: translateX(0); }

    .menu-toggle {
      position: absolute;
      top: 20px;
      left: 20px;
      background-color: #0074D9;
      color: white;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      z-index: 1100;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    .menu-toggle:hover { background-color: #005fa3; }

    .sidebar label {
      font-weight: bold;
      font-size: 14px;
      display: block;
      margin-top: 15px;
    }

    .sidebar select,
    .sidebar input[type="checkbox"],
    .sidebar input[type="text"] {
      width: 100%;
      margin-top: 5px;
      padding: 8px;
      border-radius: 6px;
      border: none;
      outline: none;
      font-size: 14px;
    }

    .sidebar .btn-secondary {
      display: block;
      margin-top: 12px;
      text-align: center;
      background-color: rgba(255,255,255,0.15);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      padding: 8px 0;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    .sidebar .btn-secondary:hover { background-color: rgba(255,255,255,0.25); }

    #themeSwitch {
      width: 100%;
      margin-top: 15px;
      border: none;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      background-color: #0074D9;
      color: white;
      transition: background-color 0.3s ease;
    }
    #themeSwitch:hover { background-color: #005fa3; }

    /* Info-window custom content */
    .info-window {
      background-color: #012040;
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 14px;
      font-family: Poppins, sans-serif;
      box-shadow: none;
      max-width: 220px;
    }
    .info-window b { color: #FFD700; }

    /* Remove default Google bubble look */
    .gm-style-iw-t::after { background: transparent !important; }
    .gm-style .gm-style-iw-c {
      padding: 0 !important;
      background-color: #012040 !important;
      box-shadow: none !important;
      border-radius: 10px !important;
      overflow: hidden !important;
    }
    .gm-style .gm-style-iw-d {
      overflow: hidden !important;
      padding: 0 !important;
    }
    .gm-ui-hover-effect {
      background-color: rgba(255,255,255,0.15) !important;
      border-radius: 8px !important;
      right: 6px !important;
      top: 6px !important;
    }
    .gm-ui-hover-effect span {
      filter: invert(1);
    }
  </style>
</head>

<body>
  <button class="menu-toggle" id="menuToggle">‚ò∞ Meny</button>
  <div class="sidebar" id="sidebar">
    <label for="company-filter">Selskap:</label>
    <select id="company-filter">
      <option value="all">Alle</option>
      <option value="Transportsentralen Oslo">Transportsentralen Oslo</option>
      <option value="Moss Transportforum">Moss Transportforum</option>
      <option value="Bl√• Kur√©r">Bl√• Kur√©r</option>
      <option value="TS Oslo Budtjenester">TS Oslo Budtjenester</option>
    </select>
    <label><input type="checkbox" id="activeToday" checked> Aktive i dag</label>
    <label for="vehicleSearch">S√∏k kj√∏ret√∏y:</label>
    <input type="text" id="vehicleSearch" placeholder="Skriv kj√∏ret√∏y-navn...">
    <div id="vehicleSuggestions" class="suggestions"></div>
    <label for="typeSearch">S√∏k biltype:</label>
    <input type="text" id="typeSearch" placeholder="Eks: varebil, lastebil...">
    <div id="typeSuggestions" class="suggestions"></div>
    <label for="placeSearch">S√∏k sted/adresse:</label>
    <input type="text" id="placeSearch" placeholder="S√∏k etter adresse...">
    <button id="themeSwitch">üåô M√∏rk modus</button>
    <a class="btn-secondary" href="cars.html">Bilpark</a>
    <a class="btn-secondary" href="dashboard.html">Dashboard</a>
  </div>
  <div id="map"></div>

  <script>
    let map, darkMode = true, markers = {}, vehicleData = [], activeInfoWindow = null;

    const darkStyle = [
      { elementType: "geometry", stylers: [{ color: "#1d2c4d" }] },
      { elementType: "labels.text.fill", stylers: [{ color: "#8ec3b9" }] },
      { elementType: "labels.text.stroke", stylers: [{ color: "#1a3646" }] },
      { featureType: "water", elementType: "geometry", stylers: [{ color: "#0e1626" }] },
      { featureType: "road", elementType: "geometry", stylers: [{ color: "#304a7d" }] },
      { featureType: "poi", elementType: "geometry", stylers: [{ color: "#283d6a" }] },
      { featureType: "landscape.natural", elementType: "geometry", stylers: [{ color: "#023e58" }] }
    ];

    const companyColors = {
      "Transportsentralen Oslo": "#ffffff",
      "Bl√• Kur√©r": "#FFD700",
      "Moss Transportforum": ["#00008b", "#8b0000"],
      "TS Oslo Budtjenester": "#004080"
    };

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 59.9139, lng: 10.7522 },
        zoom: 10,
        styles: darkMode ? darkStyle : [],
        mapTypeControl: false,
        fullscreenControl: true
      });

      document.getElementById("themeSwitch").addEventListener("click", () => {
        darkMode = !darkMode;
        map.setOptions({ styles: darkMode ? darkStyle : [] });
        document.getElementById("themeSwitch").textContent = darkMode ? "üåô M√∏rk modus" : "‚òÄÔ∏è Lys modus";
      });

      document.getElementById("menuToggle").addEventListener("click", () => {
        document.getElementById("sidebar").classList.toggle("open");
      });

      loadPositions();
      document.getElementById("company-filter").addEventListener("change", loadPositions);
      document.getElementById("activeToday").addEventListener("change", loadPositions);
      setInterval(loadPositions, 10000);

      const placeInput = document.getElementById("placeSearch");
      const autocomplete = new google.maps.places.Autocomplete(placeInput);
      autocomplete.bindTo("bounds", map);
      autocomplete.addListener("place_changed", () => {
        const place = autocomplete.getPlace();
        if (place.geometry && place.geometry.location) {
          map.panTo(place.geometry.location);
          map.setZoom(14);
        }
      });
    }

    function formatTimestamp(ts){return ts?new Date(ts).toLocaleTimeString('no-NO',{hour:'2-digit',minute:'2-digit'}):"Ukjent tid";}

    function createPinDataURL(v){
      return new Promise(r=>{
        const c=document.createElement("canvas");c.width=60;c.height=70;
        const x=c.getContext("2d");const clr=companyColors[v.company]||"#888";
        x.fillStyle=Array.isArray(clr)?clr[0]:clr;x.beginPath();x.moveTo(30,70);x.lineTo(20,50);x.lineTo(40,50);x.closePath();x.fill();
        if(Array.isArray(clr)){const g=x.createLinearGradient(0,0,60,0);g.addColorStop(0,clr[0]);g.addColorStop(1,clr[1]);x.fillStyle=g;}
        else x.fillStyle=clr;
        x.beginPath();x.arc(30,30,20,0,Math.PI*2);x.fill();
        if(v.company==="Transportsentralen Oslo"){x.lineWidth=4;x.strokeStyle="red";x.beginPath();x.arc(30,30,20,0,Math.PI*2);x.stroke();}
        const i=new Image();i.crossOrigin="anonymous";i.src=v.logo;i.onload=()=>{x.save();x.beginPath();x.arc(30,30,18,0,Math.PI*2);x.clip();x.drawImage(i,12,12,36,36);x.restore();r(c.toDataURL());};i.onerror=()=>r(c.toDataURL());
      });
    }

    async function loadPositions(){
      try{
        const res=await fetch("/api/positions");
        if(!res.ok)throw new Error("Kunne ikke hente posisjoner");
        const data=await res.json();vehicleData=data;
        const act=document.getElementById("activeToday").checked;
        const comp=document.getElementById("company-filter").value;
        const filt=data.filter(v=>(comp==="all"||v.company===comp)&&(!act||v.isActiveToday)&&v.isParticipant);
        const ids=filt.map(v=>String(v.id));

        for(const v of filt){
          if(!v.latitude||!v.longitude)continue;
          const id=String(v.id);const p={lat:v.latitude,lng:v.longitude};
          if(markers[id])markers[id].setPosition(p);
          else{
            const iconUrl=await createPinDataURL(v);
            const m=new google.maps.Marker({map,position:p,icon:{url:iconUrl,scaledSize:new google.maps.Size(45,55)},title:v.name});
            const iw=new google.maps.InfoWindow({content:`<div class="info-window"><b>Navn:</b> ${v.name}<br><b>Type:</b> ${v.type}<br><b>Palleplasser:</b> ${v.palleplasser}<br><b>Klokkeslett:</b> ${formatTimestamp(v.time)}<br><b>Selskap:</b> ${v.company}</div>`});
            google.maps.event.addListener(iw,"domready",()=>{
              const iwc=document.querySelector(".gm-style-iw-c");
              if(iwc){iwc.style.background="#012040";iwc.style.padding="0";iwc.style.boxShadow="none";}
              const iwd=document.querySelector(".gm-style-iw-d");if(iwd)iwd.style.overflow="hidden";
            });
            m.addListener("click",()=>{if(activeInfoWindow)activeInfoWindow.close();activeInfoWindow=iw;iw.open(map,m);});
            markers[id]=m;
          }
        }
        for(const id in markers)if(!ids.includes(id)){markers[id].setMap(null);delete markers[id];}
      }catch(e){console.error(e);}
    }
  </script>

  <script async
    src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap&libraries=places&v=beta">
  </script>
</body>
</html>
