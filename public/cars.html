<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Biloversikt - Triflex</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body { margin:0; font-family:'Poppins',sans-serif; background: linear-gradient(135deg, #001f3f 0%, #00122f 100%); color:#fff; }
.container { max-width:1400px; margin:20px auto; padding:20px; position:relative; }
h1 { text-align:center; margin-bottom:20px; font-size:2.5rem; }

/* Fanemeny */
.nav-tabs { width: 100%; background: #001f3f; text-align: center; margin-bottom: 20px; }
.nav-tabs ul { list-style: none; padding: 0; margin: 0; display: inline-flex; }
.nav-tabs ul li { margin: 0 10px; }
.nav-tabs ul li a { display: block; padding: 12px 20px; color: white; text-decoration: none; font-weight: 600; border-radius: 8px 8px 0 0; transition: 0.3s; }
.nav-tabs ul li a:hover, .nav-tabs ul li.active a { background: #023060; }

/* Stats grid */
.stats-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:20px; margin-bottom:30px; }
.stat-card { background: rgba(2,28,60,0.95); padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.5); text-align:center; transition: transform 0.3s; }
.stat-card:hover { transform: translateY(-5px); }
.stat-card h3 { font-size:2em; margin:10px 0; }
.stat-card p { font-size:1em; color:#cfcfcf; }

.filter-container, .search-container { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
.filter-container select, .filter-container input, .search-container input { padding:10px; border-radius:8px; border:none; background:#023060; color:white; }

.grid-container { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px,1fr)); gap:20px; margin-bottom:40px; }
.car-card { background: rgba(2,28,60,0.95); border-radius:12px; padding:20px; box-shadow:0 4px 15px rgba(0,0,0,0.5); transition: transform 0.3s; }
.car-card:hover { transform: translateY(-5px); }
.car-card h3 { margin:0; margin-bottom:5px; }
.car-card p { margin:5px 0; font-size:14px; color:#cfcfcf; }

table { width:100%; border-collapse: collapse; margin-bottom:50px; }
th, td { border:1px solid #072D60; padding:10px; text-align:left; }
th { background:#072D60; cursor:pointer; }
th:hover { background:#09458c; }
tr:nth-child(even) { background-color: rgba(255,255,255,0.05); }
tr:hover { background-color: rgba(255,255,255,0.1); }
</style>
</head>
<body>

<!-- Fanemeny -->
<nav class="nav-tabs">
  <ul>
    <li><a href="admin.html">Administrer biler</a></li>
    <li class="active"><a href="cars.html">Konsernbilpark</a></li>
    <li><a href="dashboard.html">Dashboard</a></li>
    <li><a href="kart.html">Kart</a></li>
    <li><a href="#" id="logoutTab">Logg ut</a></li>
  </ul>
</nav>

<div class="container">
<h1>Biloversikt - Triflex</h1>

<div class="stats-grid" id="globalStats">
    <div class="stat-card"><h3 id="totalCars">0</h3><p>Totalt biler</p></div>
    <div class="stat-card"><h3 id="activeCars">0</h3><p>Aktive biler i dag</p></div>
</div>

<div class="search-container">
    <input type="text" id="searchInput" placeholder="SÃ¸k bil...">
</div>
<div class="filter-container">
    <select id="companyFilter"><option value="all">Alle selskap</option></select>
    <select id="typeFilter"><option value="all">Alle typer</option></select>
    <input type="date" id="dateFilter">
</div>

<div class="grid-container" id="carsGrid"></div>

<table>
<thead>
<tr>
    <th onclick="sortTable(0)">Navn</th>
    <th onclick="sortTable(1)">Type</th>
    <th onclick="sortTable(2)">Palleplasser</th>
    <th onclick="sortTable(3)">Selskap</th>
    <th onclick="sortTable(4)">Dato & Tid</th>
</tr>
</thead>
<tbody id="vehicleTableBody"></tbody>
</table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCKqwpql2Yl0kbpUIPrQUYyVd7m1OeH-D8",
  authDomain: "triflex-a08c7.firebaseapp.com",
  projectId: "triflex-a08c7",
  storageBucket: "triflex-a08c7.firebasestorage.app",
  messagingSenderId: "835381689765",
  appId: "1:835381689765:web:e0be4b22e5f35ca1e0bc4c",
  databaseURL: "https://triflex-a08c7-default-rtdb.europe-west1.firebasedatabase.app"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let vehicleData = [];

// Sjekk login
onAuthStateChanged(auth, user => { if(!user) window.location.href = "login.html"; });

// Logout
document.getElementById('logoutTab').addEventListener('click', ()=>{ signOut(auth).then(()=>window.location.href='login.html'); });

// Last inn biler
function loadVehicles() {
    onValue(ref(db,'cars'), snapshot=>{
        if(!snapshot.exists()) return;
        vehicleData = [];
        const data = snapshot.val();
        for(const company in data){
            for(const carId in data[company]){
                const car = data[company][carId];
                if(car.isParticipant !== false){ 
                    vehicleData.push({
                        id: carId,
                        name: car.name || "",
                        type: car.type || "Ukjent",
                        palleplasser: car.palleplasser || 0,
                        company: company,
                        time: car.time || new Date().toISOString(),
                        customFields: car.customFields || {}
                    });
                }
            }
        }
        populateFilters();
        updateStats();
        updateGrid();
        updateTable();
    });
}

function updateStats() {
    document.getElementById('totalCars').textContent = vehicleData.length;
    const todayStr = new Date().toISOString().split('T')[0];
    document.getElementById('activeCars').textContent = vehicleData.filter(v => v.time.split('T')[0]===todayStr).length;
}

function populateFilters(){
    const companySelect = document.getElementById('companyFilter');
    const typeSelect = document.getElementById('typeFilter');
    companySelect.innerHTML = '<option value="all">Alle selskap</option>';
    typeSelect.innerHTML = '<option value="all">Alle typer</option>';
    const companies = [...new Set(vehicleData.map(v=>v.company))];
    const types = [...new Set(vehicleData.map(v=>v.type))];
    companies.forEach(c=>companySelect.appendChild(Object.assign(document.createElement('option'),{value:c,textContent:c})));
    types.forEach(t=>typeSelect.appendChild(Object.assign(document.createElement('option'),{value:t,textContent:t})));
}

function updateGrid(){
    const grid = document.getElementById('carsGrid');
    grid.innerHTML='';
    const search = document.getElementById('searchInput').value.toLowerCase();
    const companyVal = document.getElementById('companyFilter').value;
    const typeVal = document.getElementById('typeFilter').value;
    const dateVal = document.getElementById('dateFilter').value;

    vehicleData.filter(v=>{
        const matchSearch = v.name.toLowerCase().includes(search) || v.type.toLowerCase().includes(search) || v.company.toLowerCase().includes(search);
        const matchCompany = companyVal==='all' || v.company===companyVal;
        const matchType = typeVal==='all' || v.type===typeVal;
        const matchDate = !dateVal || v.time.split('T')[0]===dateVal;
        return matchSearch && matchCompany && matchType && matchDate;
    }).forEach(v=>{
        const card = document.createElement('div');
        card.className='car-card';
        let inner = `<h3>${v.name}</h3><p>Type: ${v.type}</p><p>Palleplasser: ${v.palleplasser}</p><p>Selskap: ${v.company}</p><p>${new Date(v.time).toLocaleString('no-NO')}</p>`;
        for(const key in v.customFields){ inner+=`<p>${key}: ${v.customFields[key]}</p>`;}
        card.innerHTML=inner;
        grid.appendChild(card);
    });
}

function updateTable(){
    const tbody = document.getElementById('vehicleTableBody');
    tbody.innerHTML='';
    const search = document.getElementById('searchInput').value.toLowerCase();
    const companyVal = document.getElementById('companyFilter').value;
    const typeVal = document.getElementById('typeFilter').value;
    const dateVal = document.getElementById('dateFilter').value;

    vehicleData.filter(v=>{
        const matchSearch = v.name.toLowerCase().includes(search) || v.type.toLowerCase().includes(search) || v.company.toLowerCase().includes(search);
        const matchCompany = companyVal==='all' || v.company===companyVal;
        const matchType = typeVal==='all' || v.type===typeVal;
        const matchDate = !dateVal || v.time.split('T')[0]===dateVal;
        return matchSearch && matchCompany && matchType && matchDate;
    }).forEach(v=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${v.name}</td><td>${v.type}</td><td>${v.palleplasser}</td><td>${v.company}</td><td>${new Date(v.time).toLocaleString('no-NO')}</td>`;
        tbody.appendChild(tr);
    });
}

// Event listeners
document.getElementById('searchInput').addEventListener('input',()=>{updateGrid();updateTable();});
document.getElementById('companyFilter').addEventListener('change',()=>{updateGrid();updateTable();});
document.getElementById('typeFilter').addEventListener('change',()=>{updateGrid();updateTable();});
document.getElementById('dateFilter').addEventListener('change',()=>{updateGrid();updateTable();});

// Sorteringstabell
let sortDirection=1,lastSortedColumn=-1;
function sortTable(idx){
    const table=document.querySelector('table');
    const rows=Array.from(table.rows).slice(1);
    const isNum = idx===2;
    const isDate = idx===4;
    if(lastSortedColumn===idx) sortDirection*=-1;
    else sortDirection=1;
    lastSortedColumn=idx;

    rows.sort((a,b)=>{
        let valA = isDate?new Date(a.cells[idx].innerText):(isNum?Number(a.cells[idx].innerText):a.cells[idx].innerText);
        let valB = isDate?new Date(b.cells[idx].innerText):(isNum?Number(b.cells[idx].innerText):b.cells[idx].innerText);
        return (valA<valB?-1:1)*sortDirection;
    });

    rows.forEach(r=>table.appendChild(r));
}

loadVehicles();
</script>

</body>
</html>
