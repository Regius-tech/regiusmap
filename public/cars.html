<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Biloversikt - Triflex</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { margin:0; font-family:'Poppins',sans-serif; background: linear-gradient(135deg, #001f3f 0%, #00122f 100%); color:#fff; }
.container { max-width:1400px; margin:20px auto; padding:20px; position:relative; }
h1 { text-align:center; margin-bottom:20px; font-size:2.5rem; }
.stats-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:20px; margin-bottom:30px; }
.stat-card { background: rgba(2,28,60,0.95); padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.5); text-align:center; transition: transform 0.3s; }
.stat-card:hover { transform: translateY(-5px); }
.stat-card h3 { font-size:2em; margin:10px 0; }
.stat-card p { font-size:1em; color:#cfcfcf; }
.filter-container, .search-container { display:flex; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
.filter-container select, .filter-container input, .search-container input { padding:10px; border-radius:8px; border:none; background:#023060; color:white; }
.top-buttons { position: absolute; top: 20px; right: 20px; display: flex; gap: 10px; }
.top-buttons a { padding: 10px 16px; background: #023060; color: white; border-radius: 8px; text-decoration: none; font-weight: bold; transition: background 0.3s; }
.top-buttons a:hover { background: #005fa3; }
.grid-container { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px,1fr)); gap:20px; margin-bottom:40px; }
.car-card { background: rgba(2,28,60,0.95); border-radius:12px; padding:20px; box-shadow:0 4px 15px rgba(0,0,0,0.5); transition: transform 0.3s; }
.car-card:hover { transform: translateY(-5px); }
.car-card h3 { margin:0; margin-bottom:5px; }
.car-card p { margin:5px 0; font-size:14px; color:#cfcfcf; }
table { width:100%; border-collapse: collapse; margin-bottom:50px; }
th, td { border:1px solid #072D60; padding:10px; text-align:left; }
th { background:#072D60; cursor:pointer; }
th:hover { background:#09458c; }
tr:nth-child(even) { background-color: rgba(255,255,255,0.05); }
tr:hover { background-color: rgba(255,255,255,0.1); }
</style>
</head>
<body>

<div class="container">
<div class="top-buttons">
    <a href="dashboard.html">Dashboard</a>
    <a href="kart.html">Kart</a>
</div>

<h1>Biloversikt - Triflex</h1>

<div class="stats-grid" id="globalStats">
    <div class="stat-card"><h3 id="totalCars">0</h3><p>Totalt biler</p></div>
    <div class="stat-card"><h3 id="activeCars">0</h3><p>Aktive biler i dag</p></div>
</div>

<div class="chart-container" style="margin-bottom:30px;">
    <canvas id="carsChart"></canvas>
</div>
<div class="chart-container" style="margin-bottom:30px;">
    <canvas id="activeChart"></canvas>
</div>

<div class="search-container">
    <input type="text" id="searchInput" placeholder="Søk bil...">
</div>
<div class="filter-container">
    <select id="companyFilter"><option value="all">Alle selskap</option></select>
    <select id="typeFilter"><option value="all">Alle typer</option></select>
    <input type="date" id="dateFilter">
</div>

<div class="grid-container" id="carsGrid"></div>

<table>
<thead>
<tr>
    <th onclick="sortTable(0)">Navn</th>
    <th onclick="sortTable(1)">Type</th>
    <th onclick="sortTable(2)">Palleplasser</th>
    <th onclick="sortTable(3)">Selskap</th>
    <th onclick="sortTable(4)">Dato & Tid</th>
</tr>
</thead>
<tbody id="vehicleTableBody"></tbody>
</table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyCKqwpql2Yl0kbpUIPrQUYyVd7m1OeH-D8",
  authDomain: "triflex-a08c7.firebaseapp.com",
  projectId: "triflex-a08c7",
  storageBucket: "triflex-a08c7.firebasestorage.app",
  messagingSenderId: "835381689765",
  appId: "1:835381689765:web:e0be4b22e5f35ca1e0bc4c",
  databaseURL: "https://triflex-a08c7-default-rtdb.europe-west1.firebasedatabase.app"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let vehicleData = [];

function updateStats() {
    document.getElementById('totalCars').textContent = vehicleData.length;
    const todayStr = new Date().toDateString();
    document.getElementById('activeCars').textContent = vehicleData.filter(v => new Date(v.time).toDateString()===todayStr).length;
}

let carsChart, activeChart;
function updateCharts() {
    const ctx1 = document.getElementById('carsChart').getContext('2d');
    const ctx2 = document.getElementById('activeChart').getContext('2d');

    const companies = [...new Set(vehicleData.map(v => v.company))];
    const carsPerCompany = companies.map(c => vehicleData.filter(v => v.company===c).length);
    const activePerCompany = companies.map(c => vehicleData.filter(v => v.company===c && new Date(v.time).toDateString()===new Date().toDateString()).length);

    if(carsChart) carsChart.destroy();
    if(activeChart) activeChart.destroy();

    carsChart = new Chart(ctx1,{
        type:'bar',
        data:{labels:companies,datasets:[{label:'Antall biler',data:carsPerCompany,backgroundColor:'#0074D9'}]},
        options:{responsive:true,plugins:{legend:{display:false}}}
    });

    activeChart = new Chart(ctx2,{
        type:'bar',
        data:{labels:companies,datasets:[{label:'Aktive biler i dag',data:activePerCompany,backgroundColor:'#FFDC00'}]},
        options:{responsive:true,plugins:{legend:{display:false}}}
    });
}

function populateFilters() {
    const companySelect = document.getElementById('companyFilter');
    const typeSelect = document.getElementById('typeFilter');
    companySelect.innerHTML = '<option value="all">Alle selskap</option>';
    typeSelect.innerHTML = '<option value="all">Alle typer</option>';

    const companies = [...new Set(vehicleData.map(v => v.company))];
    const types = [...new Set(vehicleData.map(v => v.type))];

    companies.forEach(c => companySelect.appendChild(Object.assign(document.createElement('option'), {value:c,textContent:c})));
    types.forEach(t => typeSelect.appendChild(Object.assign(document.createElement('option'), {value:t,textContent:t})));
}

function updateGrid() {
    const grid = document.getElementById('carsGrid');
    grid.innerHTML = '';
    const searchValue = document.getElementById('searchInput').value.toLowerCase();
    const companyVal = document.getElementById('companyFilter').value;
    const typeVal = document.getElementById('typeFilter').value;
    const dateVal = document.getElementById('dateFilter').value;

    vehicleData.filter(v=>{
        const matchesSearch = v.name.toLowerCase().includes(searchValue) || v.type.toLowerCase().includes(searchValue) || v.company.toLowerCase().includes(searchValue);
        const matchesCompany = companyVal==='all' || v.company===companyVal;
        const matchesType = typeVal==='all' || v.type===typeVal;
        const matchesDate = !dateVal || new Date(v.time).toISOString().split('T')[0]===dateVal;
        return matchesSearch && matchesCompany && matchesType && matchesDate;
    }).forEach(v=>{
        const card = document.createElement('div');
        card.className = 'car-card';
        card.innerHTML = `<h3>${v.name}</h3><p>Type: ${v.type}</p><p>Palleplasser: ${v.palleplasser}</p><p>Selskap: ${v.company}</p><p>${new Date(v.time).toLocaleString('no-NO')}</p>`;
        grid.appendChild(card);
    });
}

function updateTable() {
    const tbody = document.getElementById('vehicleTableBody');
    tbody.innerHTML = '';
    const searchValue = document.getElementById('searchInput').value.toLowerCase();
    const companyVal = document.getElementById('companyFilter').value;
    const typeVal = document.getElementById('typeFilter').value;
    const dateVal = document.getElementById('dateFilter').value;

    vehicleData.filter(v=>{
        const matchesSearch = v.name.toLowerCase().includes(searchValue) || v.type.toLowerCase().includes(searchValue) || v.company.toLowerCase().includes(searchValue);
        const matchesCompany = companyVal==='all' || v.company===companyVal;
        const matchesType = typeVal==='all' || v.type===typeVal;
        const matchesDate = !dateVal || new Date(v.time).toISOString().split('T')[0]===dateVal;
        return matchesSearch && matchesCompany && matchesType && matchesDate;
    }).forEach(v=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${v.name}</td><td>${v.type}</td><td>${v.palleplasser}</td><td>${v.company}</td><td>${new Date(v.time).toLocaleString('no-NO')}</td>`;
        tbody.appendChild(tr);
    });
}

// Hovedfunksjon: hent fra cars-noden
function loadVehicles() {
    onValue(ref(db,'cars'), snapshot=>{
        if(!snapshot.exists()) return;
        vehicleData = [];
        Object.values(snapshot.val()).forEach(companyCars=>{
            Object.values(companyCars).forEach(car=>{
                if(car && car.number) vehicleData.push({ id: car.number, ...car });
            });
        });
        populateFilters();
        updateStats();
        updateCharts();
        updateGrid();
        updateTable();
    });
}

// Event listeners for søk og filter
document.getElementById('searchInput').addEventListener('input', ()=>{updateGrid();updateTable();});
document.getElementById('companyFilter').addEventListener('change', ()=>{updateGrid();updateTable();});
document.getElementById('typeFilter').addEventListener('change', ()=>{updateGrid();updateTable();});
document.getElementById('dateFilter').addEventListener('change', ()=>{updateGrid();updateTable();});

// Sorteringstabell
let sortDirection = 1;
let lastSortedColumn = -1;
function sortTable(idx) {
    const table = document.querySelector('table');
    const rows = Array.from(table.rows).slice(1);
    const isNum = idx===2;
    const isDate = idx===4;
    if(lastSortedColumn===idx) sortDirection*=-1;
    else sortDirection=1;
    lastSortedColumn=idx;

    rows.sort((a,b)=>{
        let valA = isDate?new Date(a.cells[idx].innerText): (isNum?Number(a.cells[idx].innerText):a.cells[idx].innerText);
        let valB = isDate?new Date(b.cells[idx].innerText): (isNum?Number(b.cells[idx].innerText):b.cells[idx].innerText);
        return (valA<valB?-1:1)*sortDirection;
    });

    rows.forEach(r=>table.appendChild(r));
}

loadVehicles();
</script>
</body>
</html>
