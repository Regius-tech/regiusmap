<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Triflex Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { margin:0; font-family:Poppins,sans-serif; background:#001f3f; color:white; }
  .container { max-width:1400px; margin:20px auto; padding:20px; position:relative; }

  /* Fanemeny */
  .nav-tabs {
    width: 100%;
    background: #001f3f;
    text-align: center;
    margin-bottom: 20px;
  }
  .nav-tabs ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: inline-flex;
  }
  .nav-tabs ul li { margin: 0 10px; }
  .nav-tabs ul li a {
    display: block;
    padding: 12px 20px;
    color: white;
    text-decoration: none;
    font-weight: 600;
    border-radius: 8px 8px 0 0;
    transition: 0.3s;
  }
  .nav-tabs ul li a:hover,
  .nav-tabs ul li.active a { background: #023060; }

  /* Stats grid */
  .stats-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:20px; }
  .stat-card { background: rgba(2,28,60,0.95); padding:16px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.5); text-align:center; transition: transform 0.18s; }
  .stat-card h3 { font-size:1.6rem; margin:6px 0; }
  .stat-card p { margin:0; color:#cfcfcf; font-size:0.95rem; }

  /* Scoreboard */
  .scoreboard { margin: 18px 0 24px 0; background: rgba(2,28,60,0.95); padding: 12px; border-radius: 12px; box-shadow:0 4px 15px rgba(0,0,0,0.5); }
  .scoreboard table { width:100%; border-collapse:collapse; }
  .scoreboard th, .scoreboard td { padding:10px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.04); color:#e6eef6; }
  .scoreboard th { font-weight:600; color:#fff; }
  .scoreboard .small { color:#bfcfe0; font-size:0.9rem; }

  /* Filter */
  .filter-container { display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px; margin-bottom:20px; }
  .filter-container select, .filter-container input { padding:10px; border-radius:8px; border:none; background:#023060; color:white; min-width:160px; }

  /* Table */
  table.main-table { width:100%; border-collapse: collapse; margin-bottom:40px; background: rgba(2,28,60,0.0); }
  th, td { border:1px solid #072D60; padding:10px; text-align:left; color:#eaf2ff; }
  th { background:#072D60; cursor:pointer; }
  th:hover { background:#09458c; }
  tr:nth-child(even) { background-color: rgba(255,255,255,0.02); }
  tr:hover { background-color: rgba(255,255,255,0.04); }

  .chart-container { display:none; } /* behold plassering men skjul grafer per ønske */

  @media (max-width: 800px) {
    .filter-container { flex-direction:column; }
    .stats-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
  }
</style>
</head>
<body>

<!-- Fanemeny -->
<nav class="nav-tabs">
  <ul>
    <li><a href="admin.html">Administrer biler</a></li>
    <li><a href="cars.html">Konsernbilpark</a></li>
    <li class="active"><a href="dashboard.html">Dashboard</a></li>
    <li><a href="kart.html">Kart</a></li>
    <li><a href="#" id="logoutTab">Logg ut</a></li>
  </ul>
</nav>

<div class="container">

  <!-- Globale tall -->
  <div class="stats-grid" id="globalStats">
    <div class="stat-card"><p class="small">Totalt biler</p><h3 id="totalCars">0</h3></div>
    <div class="stat-card"><p class="small">Totalt deltakere (isParticipant)</p><h3 id="totalParticipants">0</h3></div>
    <div class="stat-card"><p class="small">Aktive biler i dag</p><h3 id="activeCars">0</h3></div>
    <div class="stat-card"><p class="small">Gj.snitt palleplasser</p><h3 id="avgPalle">0</h3></div>
  </div>

  <!-- Scoreboard per selskap -->
  <div class="scoreboard" id="scoreboardContainer">
    <table>
      <thead>
        <tr>
          <th>Selskap</th>
          <th>Totalt biler</th>
          <th>Deltakere</th>
          <th>Aktive i dag</th>
          <th>Gj.snitt palleplasser</th>
          <th>% utfylt type</th>
        </tr>
      </thead>
      <tbody id="scoreboardBody"></tbody>
    </table>
  </div>

  <!-- (Skjult) chart-container plassert dersom dere vil gjenbruke -->
  <div class="chart-container">
    <canvas id="carsChart"></canvas>
  </div>

  <!-- Filter / søk -->
  <div class="filter-container">
    <input type="text" id="searchInput" placeholder="Søk bil...">
    <select id="companyFilter"><option value="all">Alle selskap</option></select>
    <select id="typeFilter"><option value="all">Alle typer</option></select>
    <input type="date" id="dateFilter">
  </div>

  <!-- Tabell med biler (detaljer) -->
  <table class="main-table">
    <thead>
      <tr>
        <th onclick="sortTable(0)">Navn</th>
        <th onclick="sortTable(1)">Type</th>
        <th onclick="sortTable(2)">Palleplasser</th>
        <th onclick="sortTable(3)">Selskap</th>
        <th onclick="sortTable(4)">Dato & Tid</th>
      </tr>
    </thead>
    <tbody id="vehicleTableBody"></tbody>
  </table>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCKqwpql2Yl0kbpUIPrQUYyVd7m1OeH-D8",
  authDomain: "triflex-a08c7.firebaseapp.com",
  projectId: "triflex-a08c7",
  storageBucket: "triflex-a08c7.firebasestorage.app",
  messagingSenderId: "835381689765",
  appId: "1:835381689765:web:e0be4b22e5f35ca1e0bc4c",
  databaseURL: "https://triflex-a08c7-default-rtdb.europe-west1.firebasedatabase.app"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let vehicleData = [];

// Sjekk login
onAuthStateChanged(auth, user => {
  if (!user) window.location.href = "login.html";
});

// Logout
document.getElementById('logoutTab').addEventListener('click', ()=> {
  signOut(auth).then(()=>window.location.href='login.html');
});

// Hent biler og live update
function loadVehicles() {
  onValue(ref(db, 'cars'), snapshot => {
    if (!snapshot.exists()) {
      vehicleData = [];
      renderAll();
      return;
    }

    const data = snapshot.val();
    vehicleData = [];

    const todayStr = new Date().toISOString().split('T')[0];

    // Struktur: cars -> COMPANY -> CARID -> carObject
    for (const company in data) {
      const companyNode = data[company] || {};
      for (const carId in companyNode) {
        const car = companyNode[carId] || {};
        vehicleData.push({
          id: carId,
          name: car.name || "",
          type: car.type || "Ukjent",
          palleplasser: car.palleplasser != null ? Number(car.palleplasser) : 0,
          company: company,
          time: car.time || new Date().toISOString(),
          isParticipant: car.isParticipant !== false, // default true hvis ikke satt
          customFields: car.customFields || {}
        });
      }
    }

    renderAll();
  });
}

// Oppdater både scoreboard, globale tall, filters og tabell
function renderAll() {
  updateFilters();
  renderScoreboard();
  updateGlobalStats();
  updateTable();
}

// Update filter dropdowns
function updateFilters() {
  const companySelect = document.getElementById('companyFilter');
  const typeSelect = document.getElementById('typeFilter');
  const companies = [...new Set(vehicleData.map(v => v.company))].sort();
  const types = [...new Set(vehicleData.map(v => v.type))].sort();

  companySelect.innerHTML = '<option value="all">Alle selskap</option>';
  typeSelect.innerHTML = '<option value="all">Alle typer</option>';

  companies.forEach(c => {
    const opt = document.createElement('option'); opt.value = c; opt.textContent = c;
    companySelect.appendChild(opt);
  });
  types.forEach(t => {
    const opt = document.createElement('option'); opt.value = t; opt.textContent = t;
    typeSelect.appendChild(opt);
  });
}

// Global stats
function updateGlobalStats() {
  const total = vehicleData.length;
  const totalParticipants = vehicleData.filter(v => v.isParticipant).length;
  const todayStr = new Date().toISOString().split('T')[0];
  const activeToday = vehicleData.filter(v => (v.time||"").split('T')[0] === todayStr).length;
  const avgPalle = total ? (vehicleData.reduce((s,v)=>s + (v.palleplasser||0),0) / total) : 0;

  document.getElementById('totalCars').textContent = total;
  document.getElementById('totalParticipants').textContent = totalParticipants;
  document.getElementById('activeCars').textContent = activeToday;
  document.getElementById('avgPalle').textContent = avgPalle ? avgPalle.toFixed(1) : '0';
}

// Scoreboard per selskap
function renderScoreboard() {
  const tbody = document.getElementById('scoreboardBody');
  tbody.innerHTML = '';

  const companies = [...new Set(vehicleData.map(v => v.company))].sort();
  const todayStr = new Date().toISOString().split('T')[0];

  companies.forEach(company => {
    const cars = vehicleData.filter(v => v.company === company);
    const total = cars.length;
    const participants = cars.filter(v => v.isParticipant).length;
    const active = cars.filter(v => (v.time||"").split('T')[0] === todayStr).length;
    const avgPalle = total ? (cars.reduce((s,v)=>s + (v.palleplasser||0),0) / total) : 0;
    // prosent som ikke har "Ukjent" som type
    const filledCount = cars.filter(v => (v.type || '').toLowerCase() !== 'ukjent' && (v.type || '').toLowerCase() !== 'unknown').length;
    const percentFilled = total ? Math.round((filledCount / total) * 100) : 0;

    const tr = document.createElement('tr');
    tr.innerHTML = `<td><strong>${escapeHtml(company)}</strong></td>
                    <td>${total}</td>
                    <td>${participants}</td>
                    <td>${active}</td>
                    <td>${avgPalle ? avgPalle.toFixed(1) : '0'}</td>
                    <td>${percentFilled}%</td>`;
    tbody.appendChild(tr);
  });

  if (companies.length === 0) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="6" class="small">Ingen data tilgjengelig</td>`;
    tbody.appendChild(tr);
  }
}

// Tabell med biler (detalj)
function updateTable() {
  const tbody = document.getElementById('vehicleTableBody');
  tbody.innerHTML = '';

  const search = (document.getElementById('searchInput').value || '').toLowerCase();
  const companyVal = document.getElementById('companyFilter').value;
  const typeVal = document.getElementById('typeFilter').value;
  const dateVal = document.getElementById('dateFilter').value;

  vehicleData.filter(v => {
    const matchSearch = (v.name || '').toLowerCase().includes(search) || (v.type || '').toLowerCase().includes(search) || (v.company || '').toLowerCase().includes(search);
    const matchCompany = companyVal === 'all' || v.company === companyVal;
    const matchType = typeVal === 'all' || v.type === typeVal;
    const matchDate = !dateVal || (v.time||'').split('T')[0] === dateVal;
    return matchSearch && matchCompany && matchType && matchDate;
  }).forEach(v => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(v.name || '')}</td>
                    <td>${escapeHtml(v.type || '')}</td>
                    <td>${v.palleplasser != null ? v.palleplasser : ''}</td>
                    <td>${escapeHtml(v.company || '')}</td>
                    <td>${new Date(v.time).toLocaleString('no-NO')}</td>`;
    tbody.appendChild(tr);
  });

  // hvis ingenting matcher
  if (!tbody.children.length) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="5" class="small">Ingen biler funnet</td>`;
    tbody.appendChild(tr);
  }
}

// Escape for sikker innsetting i HTML
function escapeHtml(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
}

// Sorteringstabell
let sortDirection = 1;
let lastSortedColumn = -1;
function sortTable(idx) {
  const table = document.querySelector('table.main-table');
  const rows = Array.from(table.rows).slice(1);
  const isNum = idx === 2;
  const isDate = idx === 4;
  if (lastSortedColumn === idx) sortDirection *= -1; else sortDirection = 1;
  lastSortedColumn = idx;

  rows.sort((a,b) => {
    let valA = isDate ? new Date(a.cells[idx].innerText) : (isNum ? Number(a.cells[idx].innerText) : a.cells[idx].innerText.toLowerCase());
    let valB = isDate ? new Date(b.cells[idx].innerText) : (isNum ? Number(b.cells[idx].innerText) : b.cells[idx].innerText.toLowerCase());
    if (valA < valB) return -1 * sortDirection;
    if (valA > valB) return 1 * sortDirection;
    return 0;
  });

  rows.forEach(r => table.appendChild(r));
}

// Event listeners for filters/search
document.getElementById('searchInput').addEventListener('input', updateTable);
document.getElementById('companyFilter').addEventListener('change', () => { renderScoreboard(); updateTable(); });
document.getElementById('typeFilter').addEventListener('change', updateTable);
document.getElementById('dateFilter').addEventListener('change', updateTable);

// Init
loadVehicles();
</script>

</body>
</html>
